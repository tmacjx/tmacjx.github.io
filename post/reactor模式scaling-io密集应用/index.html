<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Reactor模式Scaling I/O密集应用 - tmacKan - A record for Life</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="tmackan"><meta name=description content="设计实现一个I/O密集型的聊天室应用 1.单线程/多线程? 单进程/多进程? 2.阻塞io/非阻塞io/多路复用？ 1.多线程阻塞I/O 在循环中等待"><meta name=keywords content="Blog,Python,code"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=http://localhost:1313/post/reactor%E6%A8%A1%E5%BC%8Fscaling-io%E5%AF%86%E9%9B%86%E5%BA%94%E7%94%A8/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.651e6917abb0239242daa570c2bec9867267bbcd83646da5a850afe573347b44.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Reactor模式Scaling I/O密集应用"><meta property="og:description" content="设计实现一个I/O密集型的聊天室应用 1.单线程/多线程? 单进程/多进程? 2.阻塞io/非阻塞io/多路复用？ 1.多线程阻塞I/O 在循环中等待"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/reactor%E6%A8%A1%E5%BC%8Fscaling-io%E5%AF%86%E9%9B%86%E5%BA%94%E7%94%A8/"><meta property="article:published_time" content="2020-08-28T15:00:00+00:00"><meta property="article:modified_time" content="2020-08-28T15:00:00+00:00"><meta itemprop=name content="Reactor模式Scaling I/O密集应用"><meta itemprop=description content="设计实现一个I/O密集型的聊天室应用 1.单线程/多线程? 单进程/多进程? 2.阻塞io/非阻塞io/多路复用？ 1.多线程阻塞I/O 在循环中等待"><meta itemprop=datePublished content="2020-08-28T15:00:00+00:00"><meta itemprop=dateModified content="2020-08-28T15:00:00+00:00"><meta itemprop=wordCount content="3420"><meta itemprop=keywords content="翻译,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Reactor模式Scaling I/O密集应用"><meta name=twitter:description content="设计实现一个I/O密集型的聊天室应用 1.单线程/多线程? 单进程/多进程? 2.阻塞io/非阻塞io/多路复用？ 1.多线程阻塞I/O 在循环中等待"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>tmackan</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>tmackan</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Reactor模式Scaling I/O密集应用</h1><div class=post-meta><span class=post-time>2020-08-28</span><div class=post-category><a href=/categories/%E6%8A%80%E6%9C%AF/>技术</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1多线程阻塞io>1.<strong>多线程阻塞I/O</strong></a></li><li><a href=#2单线非阻塞io>2.<strong>单线非阻塞I/O</strong></a></li><li><a href=#3单线程同步事件多路io>3.<strong>单线程同步事件多路I/O</strong></a></li><li><a href=#4python-echo-server-and-client-implementation-using-selectors>4.<strong>Python Echo Server and Client Implementation, using Selectors</strong></a></li><li><a href=#5python-chat-server-and-client-implementation-using-selectors>5.<strong>Python Chat Server and Client Implementation using Selectors</strong></a></li><li><a href=#6reactor-design-pattern>6.<strong>Reactor Design Pattern</strong></a></li><li><a href=#7其他应用>7.<strong>其他应用</strong></a></li></ul></li></ul></li></ul></nav></div></div><div class=post-content><p>设计实现一个I/O密集型的聊天室应用
1.单线程/多线程? 单进程/多进程?
2.阻塞io/非阻塞io/多路复用？</p><h3 id=1多线程阻塞io>1.<strong>多线程阻塞I/O</strong></h3><p><img src=https://hila.sh/assets/images/Server%20with%20Blocking%20Sockets.png alt></p><ol><li>在循环中等待连接</li><li>对于每个新的连接，开启单独的线程
在线程中，收发消息</li></ol><p>阻塞模式中，操作阻塞直到完成，或者操作系统返回错误(比如连接超时)
当socket等待io(比如recv或者send)，会阻塞io可用(或者发生错误)
所以相当1k个并发连接，我们需要创建1k个线程(单线程阻塞模式下，无法支持多路accept)</p><p>效率低的原因
1.大多数的线程等待io时阻塞，这时cpu会进行上下文切换，占用cpu时间
线程越多浪费在切换上的时间越多
2.当我们想要获取线程1000的消息，不得不检查线程1-999
3.线程多会造成内存浪费</p><p>BlockingEchoServer.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>socket</span>
<span class=kn>import</span> <span class=nn>threading</span>

<span class=k>def</span> <span class=nf>echo</span><span class=p>(</span><span class=n>conn</span><span class=p>):</span>
   <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
       <span class=c1># blocks the thread until data is received</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
       <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span> <span class=k>break</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>

<span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>
   <span class=n>s</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>1234</span><span class=p>))</span>
   <span class=n>s</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
   <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
       <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
       <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>echo</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>conn</span><span class=p>,))</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>

</code></pre></td></tr></table></div></div><p>BlockingEchoClient.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>socket</span>

<span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>
   <span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>1234</span><span class=p>))</span>
   <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
       <span class=n>s</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=nb>input</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
       <span class=k>print</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>))</span>
</code></pre></td></tr></table></div></div><h3 id=2单线非阻塞io>2.<strong>单线非阻塞I/O</strong></h3><p><img src=https://hila.sh/assets/images/Server%20with%20Non-Blocking%20Loop.png alt></p><p>非阻塞， 如果操作不能立即完成则返回失败</p><p>1.创建socket列表
2.遍历socket列表
对于每个非阻塞的socket，尝试read和write
这些操作会立即返回(即使io没有ready)</p><p>1.创建了非阻塞server socket，用于接收连接</p><p>控制流是基于BlockingIOError异常的
当连接关闭时 recv会返回b"&ldquo;空字符，当没有数据时，recv会raise BlockingIOError
需要保存已关闭的连接在下次循环的时候进行清除</p><p>BusyWaitNonBlockingEchoServer.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>socket</span>

<span class=n>sockets</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=n>remove_pending</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>server</span><span class=p>:</span>
   <span class=n>server</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>2002</span><span class=p>))</span>
   <span class=n>server</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
   <span class=n>server</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>      <span class=c1># set Non-Blocking socket</span>
   <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
       <span class=k>try</span><span class=p>:</span>
           <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
           <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
           <span class=n>sockets</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
       <span class=k>except</span> <span class=n>BlockingIOError</span><span class=p>:</span> <span class=c1># [Errno 35] Resource temporarily unavailable - indicates that &#34;accept&#34; returned without results</span>
           <span class=k>pass</span>

       <span class=n>remove_pending</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
       <span class=k>for</span> <span class=n>conn</span> <span class=ow>in</span> <span class=n>sockets</span><span class=p>:</span>
           <span class=k>try</span><span class=p>:</span>
               <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
               <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span> <span class=c1># connection closed</span>
                   <span class=n>remove_pending</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
               <span class=k>else</span><span class=p>:</span>
                   <span class=k>print</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
                   <span class=n>conn</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
           <span class=k>except</span> <span class=n>BlockingIOError</span><span class=p>:</span>  <span class=c1># recv/send return without data.</span>
               <span class=k>pass</span>

       <span class=c1># remove closed connections</span>
       <span class=k>for</span> <span class=n>conn</span> <span class=ow>in</span> <span class=n>remove_pending</span><span class=p>:</span>
           <span class=n>sockets</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>BusyWaitNonBlockingEchoClient.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>import socket

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
   s.connect((&#39;localhost&#39;, 2002))
   while True:
       s.sendall(input().encode(&#39;utf-8&#39;))
       print(s.recv(1024))
</code></pre></td></tr></table></div></div><p>1.我们需要循环遍历所有的socket，无论它的状态
对于每个socket，至少要调用一次操作系统命令
如果我们有10k个socket，为了查找一个消息不得不遍历所有的socket
这意味着只能让新进入的消息等待，然后花费宝贵的时间去检查socket的状态
2.大多数的时间，我们轮训每个socket检查它的状态
这一直在浪费cpu，99%的时间都在轮训而不是在执行业务逻辑</p><h3 id=3单线程同步事件多路io>3.<strong>单线程同步事件多路I/O</strong></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>SYNOPSIS

#include &lt;sys/select.h&gt;
int
     select(int nfds, fd_set *restrict readfds, fd_set *restrict writefds, fd_set *restrict errorfds, struct timeval *restrict timeout);

DESCRIPTION
select() and pselect() allow a program to monitor multiple file
       descriptors, waiting until one or more of the file descriptors become
       &#34;ready&#34; for some class of I/O operation (e.g., input possible).  A
       file descriptor is considered ready if it is possible to perform a
       corresponding I/O operation (e.g., read(2), or a sufficiently small
       write(2)) without blocking.  

select() examines the I/O descriptor sets whose addresses are passed in readfds, writefds, and errorfds to see if some of their descriptors are ready for reading, are ready
     for writing, or have an exceptional condition pending, respectively. On return, select()
     replaces the given descriptor sets with subsets consisting of those descriptors that are ready for the requested operation.  select() returns the total number of ready
     descriptors in all the sets.
</code></pre></td></tr></table></div></div><p>select是系统调用，监控file descriptors的状态，当他们可read/可write/error时候返回</p><p>readfds
一组监控的文件描述符，当他们中的任一可读后，select会将其返回
writefds
一组监控的文件描述符，当他们中的任一可写后，select会将其返回
errorfds
一组监控的文件描述符，当他们中的任一异常时，select会将其返回</p><p>select调用会阻塞直到相关的事件发生(可读/可写/异常)</p><p>select本身有限制，最多监控数为1024，事件复杂度是O(n)
1.select所有平台
2.poll(大多数POSIX平台)
3.epoll(linux)使用红黑树存储监控的文件描述符
4.kqueue (FreeBSD, macOS)
5.IOCP - Input/output completion port (Windows)</p><h3 id=4python-echo-server-and-client-implementation-using-selectors>4.<strong>Python Echo Server and Client Implementation, using Selectors</strong></h3><p><img src=https://hila.sh/assets/images/Select%20Server.png alt></p><p>py包只能够有两个模块支持异步io
select和selectors
selectors做了更好的封装
1.根据系统，选择更好的模型 epoll|kqueue|devpoll > poll >select
2.定义了BaseSelector基类，可以注册/取消注册一组读/写文件描述符
省去自己存储read/write文件描述符</p><p>selector.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=c1># Choose the best implementation, roughly:</span>
<span class=c1>#    epoll|kqueue|devpoll &gt; poll &gt; select.</span>
<span class=c1># select() also can&#39;t accept a FD &gt; FD_SETSIZE (usually around 1024)</span>
<span class=k>if</span> <span class=s1>&#39;KqueueSelector&#39;</span> <span class=ow>in</span> <span class=nb>globals</span><span class=p>():</span>
    <span class=n>DefaultSelector</span> <span class=o>=</span> <span class=n>KqueueSelector</span>
<span class=k>elif</span> <span class=s1>&#39;EpollSelector&#39;</span> <span class=ow>in</span> <span class=nb>globals</span><span class=p>():</span>
    <span class=n>DefaultSelector</span> <span class=o>=</span> <span class=n>EpollSelector</span>
<span class=k>elif</span> <span class=s1>&#39;DevpollSelector&#39;</span> <span class=ow>in</span> <span class=nb>globals</span><span class=p>():</span>
    <span class=n>DefaultSelector</span> <span class=o>=</span> <span class=n>DevpollSelector</span>
<span class=k>elif</span> <span class=s1>&#39;PollSelector&#39;</span> <span class=ow>in</span> <span class=nb>globals</span><span class=p>():</span>
    <span class=n>DefaultSelector</span> <span class=o>=</span> <span class=n>PollSelector</span>
<span class=k>else</span><span class=p>:</span>
    <span class=n>DefaultSelector</span> <span class=o>=</span> <span class=n>SelectSelector</span>
</code></pre></td></tr></table></div></div><h4 id=python-echo-server>Python Echo Server</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=n>sel</span> <span class=o>=</span> <span class=n>selectors</span><span class=o>.</span><span class=n>DefaultSelector</span><span class=p>()</span>
<span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>()</span>
<span class=n>sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=mi>1234</span><span class=p>))</span>
<span class=n>sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
<span class=n>sock</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
<span class=n>sel</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=n>accept</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>首先创建一个selector，然后创建一个server socket绑定1234端口 开启监听
设置为非阻塞模式
[sock, selectors.EVENT_READ, accept] # 监听socket，单socket可读的时，调用accpet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
   <span class=n>events</span> <span class=o>=</span> <span class=n>sel</span><span class=o>.</span><span class=n>select</span><span class=p>()</span>
   <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>mask</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
       <span class=n>callback</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>data</span>
       <span class=n>callback</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>fileobj</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>while中等待select阻塞调用, select调用当监控的文件可读/可写的时候返回，然后调用事件关联的回调</p><p>1.当新client连接时，select会判断server socket可读了，然后调用accept
accept会接口新的连接，并创建一个新的conn socket，并且设置为非阻塞模式。
然后注册新的conn socket在selector中，当socket可读时，调用read方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=k>def</span> <span class=nf>accept</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
   <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>  <span class=c1># Should be ready</span>
   <span class=k>print</span><span class=p>(</span><span class=s1>&#39;accepted&#39;</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=s1>&#39;from&#39;</span><span class=p>,</span> <span class=n>addr</span><span class=p>)</span>
   <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
   <span class=n>sel</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=n>read</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>read</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
   <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>  <span class=c1># Should be ready</span>
   <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
       <span class=k>print</span><span class=p>(</span><span class=s1>&#39;echoing&#39;</span><span class=p>,</span> <span class=nb>repr</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=s1>&#39;to&#39;</span><span class=p>,</span> <span class=n>conn</span><span class=p>)</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>  <span class=c1># Hope it won&#39;t block</span>
   <span class=k>else</span><span class=p>:</span>
       <span class=k>print</span><span class=p>(</span><span class=s1>&#39;closing&#39;</span><span class=p>,</span> <span class=n>conn</span><span class=p>)</span>
       <span class=n>sel</span><span class=o>.</span><span class=n>unregister</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h4 id=python-echo-client>Python Echo Client</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=c1># Echo client program</span>
<span class=kn>import</span> <span class=nn>socket</span>

<span class=n>HOST</span> <span class=o>=</span> <span class=s1>&#39;localhost&#39;</span>        <span class=c1># The remote host</span>
<span class=n>PORT</span> <span class=o>=</span> <span class=mi>1234</span>               <span class=c1># The same port as used by the server</span>
<span class=k>with</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span> <span class=k>as</span> <span class=n>s</span><span class=p>:</span>
   <span class=n>s</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>))</span>
   <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
       <span class=n>msg</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Enter msg: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
       <span class=n>s</span><span class=o>.</span><span class=n>sendall</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>

       <span class=n>data</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1024</span><span class=p>)</span>
       <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Received: &#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
<span class=n>The</span> <span class=n>client</span> <span class=n>connects</span> <span class=n>to</span> <span class=n>the</span> <span class=n>server</span><span class=p>,</span>  <span class=n>sends</span> <span class=n>a</span> <span class=n>message</span> <span class=ow>and</span> <span class=n>wait</span> <span class=k>for</span> <span class=n>a</span> <span class=n>re</span>
</code></pre></td></tr></table></div></div><p>client连接server，发送消息并等待server响应
recv阻塞直到收到server的响应</p><p>输出
EchoClient.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Enter msg: Hello
Received:  Hello
Enter msg: How r u?
Received:  How r u?
Enter msg: Great, Thanks for asking.
Received:  Great, Thanks for asking.
</code></pre></td></tr></table></div></div><p>EchoServer.py</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>accepted &lt;socket.socket fd=7, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=(&#39;127.0.0.1&#39;, 1234), raddr=(&#39;127.0.0.1&#39;, 65167)&gt; from (&#39;127.0.0.1&#39;, 65167)
echoing b&#39;Hello&#39; to &lt;socket.socket fd=7, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=(&#39;127.0.0.1&#39;, 1234), raddr=(&#39;127.0.0.1&#39;, 65167)&gt;
echoing b&#39;How r u?&#39; to &lt;socket.socket fd=7, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=(&#39;127.0.0.1&#39;, 1234), raddr=(&#39;127.0.0.1&#39;, 65167)&gt;
echoing b&#39;Great, Thanks for asking.&#39; to &lt;socket.socket fd=7, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=0, laddr=(&#39;127.0.0.1&#39;, 1234), raddr=(&#39;127.0.0.1&#39;, 65167)&gt;

</code></pre></td></tr></table></div></div><h3 id=5python-chat-server-and-client-implementation-using-selectors>5.<strong>Python Chat Server and Client Implementation using Selectors</strong></h3><h4 id=python-chat-server>Python Chat Server</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=k>class</span> <span class=nc>ChatServer</span><span class=p>:</span>

   <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span> <span class=o>=</span> <span class=n>selectors</span><span class=o>.</span><span class=n>DefaultSelector</span><span class=p>()</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span> <span class=o>=</span> <span class=p>{}</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_host</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>]</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_port</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><h5 id=accepting-a-new-connection>Accepting a New Connection</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py>   <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
       <span class=c1># create and register server socket for reading (accepting new connections)</span>
       <span class=n>server_sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>()</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>_host</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_port</span><span class=p>))</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=n>SERVER_NUM_CONNECTIONS</span><span class=p>)</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>server_sock</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_accept</span><span class=p>)</span>

       <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
           <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>select</span><span class=p>()</span>
           <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>mask</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
               <span class=n>callback</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>data</span>
               <span class=n>callback</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>fileobj</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h5 id=adding-a-new-connection>Adding a New Connection</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=k>def</span> <span class=nf>_accept</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sock</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_add_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_add_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=c1># register new client connection for reading (accepting new messages)</span>
       <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{conn.getpeername()} hello!&#39;</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=p>[</span><span class=n>conn</span><span class=p>]</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h5 id=recieve-a-new-message-from-a-connection>Recieve a new message from a connection</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py> <span class=k>def</span> <span class=nf>_read</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_read_message</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_read_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>BUFFER_SIZE</span><span class=p>)</span>  <span class=c1># Should be ready</span>
       <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_add_message</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
       <span class=k>else</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_remove_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_add_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sender_conn</span><span class=p>,</span> <span class=n>raw_msg</span><span class=p>):</span>
       <span class=k>try</span><span class=p>:</span>
           <span class=n>msg</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>raw_msg</span><span class=p>)</span>
           <span class=n>message</span> <span class=o>=</span> <span class=n>Message</span><span class=p>(</span><span class=n>msg</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>],</span> <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>])</span>
           <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;{sender_conn.getpeername()}: [{msg[&#39;user&#39;]}] {msg[&#39;text&#39;]}&#34;</span><span class=p>)</span>
       <span class=k>except</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
           <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;We got unknown type of message: {raw_msg}; error: {e}&#34;</span><span class=p>)</span>
           <span class=k>return</span>

       <span class=c1># register every client connection for writing (broadcast recent messages)</span>
       <span class=k>for</span> <span class=n>conn</span><span class=p>,</span> <span class=n>messages</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
           <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>  <span class=c1># not sure if needed</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>modify</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span> <span class=o>|</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_WRITE</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_write</span><span class=p>)</span>
           <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>将最新的消息都要发送到每个client，所以这里遍历所有的连接client，然后modify selector的事件
当sock可写的时候发送消息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py> <span class=k>def</span> <span class=nf>_read_write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=k>if</span> <span class=n>mask</span> <span class=o>&amp;</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
       <span class=k>if</span> <span class=n>mask</span> <span class=o>&amp;</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_WRITE</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_write</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h5 id=broadcasting-recent-messages-to-all-connections>Broadcasting recent messages to all connections</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=k>def</span> <span class=nf>_write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_write_pending_messages</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_write_pending_messages</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=n>messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=p>[</span><span class=n>conn</span><span class=p>]</span>
       <span class=k>while</span> <span class=n>messages</span><span class=p>:</span>
           <span class=n>msg</span> <span class=o>=</span> <span class=n>messages</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
           <span class=k>try</span><span class=p>:</span>
               <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;[{msg.user}] {msg.text}&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
           <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
               <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Error occurred&#39;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
               <span class=bp>self</span><span class=o>.</span><span class=n>_remove_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
               <span class=k>return</span>

       <span class=c1># if no more message to send, don&#39;t listen to available for write</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>  <span class=c1># not sure if needed</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>modify</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>当queue中没有多余的消息后，modify socket的状态，只监控socket的可读状态</p><p>完整代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>argparse</span>
<span class=kn>import</span> <span class=nn>collections</span>
<span class=kn>import</span> <span class=nn>json</span>
<span class=kn>import</span> <span class=nn>selectors</span>
<span class=kn>import</span> <span class=nn>socket</span>


<span class=n>SERVER_NUM_CONNECTIONS</span> <span class=o>=</span> <span class=mi>1000</span>
<span class=n>BUFFER_SIZE</span> <span class=o>=</span> <span class=mi>1000</span>

<span class=n>Message</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Message&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=s1>&#39;text&#39;</span><span class=p>])</span>


<span class=k>class</span> <span class=nc>ChatServer</span><span class=p>:</span>

   <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span> <span class=o>=</span> <span class=n>selectors</span><span class=o>.</span><span class=n>DefaultSelector</span><span class=p>()</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span> <span class=o>=</span> <span class=p>{}</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_host</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>]</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_port</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span>

   <span class=c1>##### SELECT FUNCTIONS ########################</span>

   <span class=k>def</span> <span class=nf>_accept</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sock</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=n>conn</span><span class=p>,</span> <span class=n>addr</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_add_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_read_write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=k>if</span> <span class=n>mask</span> <span class=o>&amp;</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
       <span class=k>if</span> <span class=n>mask</span> <span class=o>&amp;</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_WRITE</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_write</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_read</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_read_message</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_write_pending_messages</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=c1>##### CHAT FUNCTIONS ########################</span>

   <span class=k>def</span> <span class=nf>_add_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=c1># register new client connection for reading (accepting new messages)</span>
       <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{conn.getpeername()} hello!&#39;</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=p>[</span><span class=n>conn</span><span class=p>]</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_remove_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;{conn.getpeername()} bye bye!&#39;</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>unregister</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
       <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=p>[</span><span class=n>conn</span><span class=p>]</span>

   <span class=k>def</span> <span class=nf>_read_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>BUFFER_SIZE</span><span class=p>)</span>  <span class=c1># Should be ready</span>
       <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_add_message</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
       <span class=k>else</span><span class=p>:</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_remove_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_add_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sender_conn</span><span class=p>,</span> <span class=n>raw_msg</span><span class=p>):</span>
       <span class=k>try</span><span class=p>:</span>
           <span class=n>msg</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>raw_msg</span><span class=p>)</span>
           <span class=n>message</span> <span class=o>=</span> <span class=n>Message</span><span class=p>(</span><span class=n>msg</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>],</span> <span class=n>msg</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>])</span>
           <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;{sender_conn.getpeername()}: [{msg[&#39;user&#39;]}] {msg[&#39;text&#39;]}&#34;</span><span class=p>)</span>
       <span class=k>except</span> <span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
           <span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=s2>&#34;We got unknown type of message: {raw_msg}; error: {e}&#34;</span><span class=p>)</span>
           <span class=k>return</span>

       <span class=c1># register every client connection for writing (broadcast recent messages)</span>
       <span class=k>for</span> <span class=n>conn</span><span class=p>,</span> <span class=n>messages</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
           <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>  <span class=c1># not sure if needed</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>modify</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span> <span class=o>|</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_WRITE</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_write</span><span class=p>)</span>
           <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>_write_pending_messages</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>):</span>
       <span class=n>messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections_msg_queue</span><span class=p>[</span><span class=n>conn</span><span class=p>]</span>
       <span class=k>while</span> <span class=n>messages</span><span class=p>:</span>
           <span class=n>msg</span> <span class=o>=</span> <span class=n>messages</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
           <span class=k>try</span><span class=p>:</span>
               <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>f</span><span class=s1>&#39;[{msg.user}] {msg.text}&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
           <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
               <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Error occurred&#39;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
               <span class=bp>self</span><span class=o>.</span><span class=n>_remove_connection</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
               <span class=k>return</span>

       <span class=c1># if no more message to send, don&#39;t listen to available for write</span>
       <span class=n>conn</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>  <span class=c1># not sure if needed</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>modify</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read</span><span class=p>)</span>

   <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
       <span class=c1># create and register server socket for reading (accepting new connections)</span>
       <span class=n>server_sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>()</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>_host</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_port</span><span class=p>))</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=n>SERVER_NUM_CONNECTIONS</span><span class=p>)</span>
       <span class=n>server_sock</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>server_sock</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_accept</span><span class=p>)</span>

       <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
           <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>select</span><span class=p>()</span>
           <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>mask</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
               <span class=n>callback</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>data</span>
               <span class=n>callback</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>fileobj</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>


<span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s1>&#39;Chat server arguments.&#39;</span><span class=p>)</span>
<span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-host&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>)</span>
<span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-port&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1234</span><span class=p>)</span>
<span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>

<span class=n>chat</span> <span class=o>=</span> <span class=n>ChatServer</span><span class=p>(</span><span class=o>**</span><span class=nb>vars</span><span class=p>(</span><span class=n>args</span><span class=p>))</span>
<span class=n>chat</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h4 id=python-chat-client>Python Chat Client</h4><p>selector监控stdin</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>argparse</span>
<span class=kn>import</span> <span class=nn>collections</span>
<span class=kn>import</span> <span class=nn>json</span>
<span class=kn>import</span> <span class=nn>selectors</span>
<span class=kn>import</span> <span class=nn>socket</span>
<span class=kn>import</span> <span class=nn>sys</span>


<span class=n>BUFFER_SIZE</span> <span class=o>=</span> <span class=mi>1000</span>

<span class=n>Message</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;Message&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=s1>&#39;text&#39;</span><span class=p>])</span>


<span class=k>class</span> <span class=nc>ChatClient</span><span class=p>:</span>

   <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span> <span class=o>=</span> <span class=n>selectors</span><span class=o>.</span><span class=n>DefaultSelector</span><span class=p>()</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_sock</span> <span class=o>=</span> <span class=bp>None</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_host</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;host&#39;</span><span class=p>]</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_port</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_name</span> <span class=o>=</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=nb>input</span><span class=p>(</span><span class=s1>&#39;Enter username:&#39;</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_running</span> <span class=o>=</span> <span class=bp>True</span>

   <span class=k>def</span> <span class=nf>_read_stdin</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>input</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
       <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
           <span class=n>msg</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span><span class=s1>&#39;user&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_name</span><span class=p>,</span> <span class=s1>&#39;text&#39;</span><span class=p>:</span> <span class=n>data</span><span class=p>},</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>)</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span> <span class=c1># We should wait for selector here, but it will work.</span>

   <span class=k>def</span> <span class=nf>_read_msg</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>conn</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>BUFFER_SIZE</span><span class=p>)</span>  <span class=c1># Should be ready</span>
       <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
           <span class=k>print</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
       <span class=k>else</span><span class=p>:</span>
           <span class=k>print</span><span class=p>(</span><span class=s1>&#39;Connection to server has failed&#39;</span><span class=p>)</span>
           <span class=bp>self</span><span class=o>.</span><span class=n>_running</span> <span class=o>=</span> <span class=bp>False</span>

   <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>stdin</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_stdin</span><span class=p>)</span>

       <span class=bp>self</span><span class=o>.</span><span class=n>_sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=bp>self</span><span class=o>.</span><span class=n>_host</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_port</span><span class=p>))</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_sock</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
       <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_sock</span><span class=p>,</span> <span class=n>selectors</span><span class=o>.</span><span class=n>EVENT_READ</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_msg</span><span class=p>)</span>

       <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>_running</span><span class=p>:</span>
           <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_selector</span><span class=o>.</span><span class=n>select</span><span class=p>()</span>
           <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>mask</span> <span class=ow>in</span> <span class=n>events</span><span class=p>:</span>
               <span class=n>callback</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>data</span>
               <span class=n>callback</span><span class=p>(</span><span class=n>key</span><span class=o>.</span><span class=n>fileobj</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>


<span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s1>&#39;Chat client arguments.&#39;</span><span class=p>)</span>
<span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-host&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>)</span>
<span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-port&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1234</span><span class=p>)</span>
<span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-username&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;?&#39;</span><span class=p>)</span>
<span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>

<span class=n>chat</span> <span class=o>=</span> <span class=n>ChatClient</span><span class=p>(</span><span class=o>**</span><span class=nb>vars</span><span class=p>(</span><span class=n>args</span><span class=p>))</span>
<span class=n>chat</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h3 id=6reactor-design-pattern>6.<strong>Reactor Design Pattern</strong></h3><p><img src=https://hila.sh/assets/images/reactor_interaction_diagram.png alt></p><p><img src=https://hila.sh/assets/images/Select%20Server.png alt></p><h3 id=7其他应用>7.<strong>其他应用</strong></h3><h4 id=libuv>libuv</h4><p>Node.js的非阻塞i/o引擎
<img src=http://docs.libuv.org/en/v1.x/_images/architecture.png alt>
<img src=https://hila.sh/assets/images/nodejs.png alt></p><h4 id=nginx>nginx</h4><p>worker process工作进程（单线程）实现了reactor模式的event loop去处理io任务</p><h4 id=twisted>Twisted</h4><p>python中事件驱动的网络引擎
可以被实现为多种server(http, mail, pub/sub)</p><p>来自
<a href=https://hila.sh/2019/12/28/reactor.html>https://hila.sh/2019/12/28/reactor.html</a></p><p>相关链接
<a href=https://infloop.tw/2015/02/19/reactor-pattern-in-python/>https://infloop.tw/2015/02/19/reactor-pattern-in-python/</a></p><p><a href=https://infloop.tw/2015/02/14/nonblocking-io-and-io-multiplexing/>https://infloop.tw/2015/02/14/nonblocking-io-and-io-multiplexing/</a></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>tmackan</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-08-28</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/%E7%BF%BB%E8%AF%91/>翻译</a></div><nav class=post-nav><a class=prev href=/post/tob%E8%A1%8C%E4%B8%9A%E7%A0%94%E5%8F%91%E6%80%9D%E8%80%83/><i class="iconfont icon-left"></i><span class="prev-text nav-default">toB行业研发思考</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/kibana%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/><span class="next-text nav-default">Kibana查询语法</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=tmacjx/https://github.com/tmacjx/utterances issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:kan49733110@email.com class="iconfont icon-email" title=email></a><a href=http://twitter.com/tmcakan/ class="iconfont icon-twitter" title=twitter></a><a href=http://github.com/tmacjx/ class="iconfont icon-github" title=github></a><a href=https://www.zhihu.com/people/kan-tmac class="iconfont icon-zhihu" title=zhihu></a><a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2016 -
2021
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>tmackan</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-174638881-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>